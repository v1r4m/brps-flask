<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoundCloud Shuffle Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <style>
        #loading {
            display: none;
            font-size: 1.2em;
            color: #555;
            margin: 20px 0;
        }
    </style>
    <script>
        let tracks = [];
        let currentTrackIndex = 0;
        let player = null;
        let playlistLoaded = false;

        async function fetchTracks() {
            const playlistId = "{{ playlist_id }}"; 
            document.getElementById("loading").style.display = "block";
            const response = await fetch(`/playlist/${playlistId}`);
            tracks = await response.json();
            playlistLoaded = true;
            document.getElementById("loading").style.display = "none";
            console.log("Fetched Tracks:", tracks);
        }

        function playTrack() {
            if (!playlistLoaded || tracks.length === 0) {
                console.log("Tracks not ready.");
                return;
            }

            document.getElementById("loading").style.display = "block";

            let track = tracks[currentTrackIndex];
            let streamUrl = `/stream/${track.id}`;

            console.log(`Playing Track: ${track.title}`);

            if (player) {
                player.stop();
            }

            player = new Howl({
                src: [streamUrl],
                format: ['mp3'],
                html5: false,
                autoplay: true,
                volume: 1.0,
                onplay: function () {
                    document.getElementById("loading").style.display = "none";
                },
                onend: function () {
                    console.log(`Finished: ${track.title}`);
                    nextTrack();
                },
                onloaderror: function (id, err) {
                    console.error("Load Error:", err);
                    document.getElementById("loading").style.display = "none";
                },
                onplayerror: function (id, err) {
                    console.error("Play Error:", err);
                    document.getElementById("loading").style.display = "none";
                }
            });
        }

        function nextTrack() {
            currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
            console.log("Next track index:", currentTrackIndex);
            playTrack();
        }

        async function initPlayer() {
            await fetchTracks();
            playTrack();
        }
    </script>
</head>
<body>
    <h1>SoundCloud Shuffle Player (Flask + Howler.js)</h1>
    <div id="loading">ðŸŽµ Loading...</div>
    <button onclick="initPlayer()">Start Playing</button>
</body>
</html>
