<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoundCloud Shuffle Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <script>
        let tracks = [];
        let currentTrackIndex = 0;
        let player = null;

        async function fetchTracks() {
            const playlistId = "{{ playlist_id }}"; 
            const response = await fetch(`/playlist/${playlistId}`);
            tracks = await response.json();
            console.log("Fetched Tracks:", tracks);
        }

        function playTrack() {
            if (tracks.length === 0) {
                console.log("No tracks available.");
                return;
            }

            let track = tracks[currentTrackIndex];
            let streamUrl = `/stream/${track.id}`; // ðŸ”¥ Flaskì—ì„œ MP3 Blobì„ ì œê³µ

            console.log(`Playing Track: ${track.title}`);

            if (player) {
                player.stop();
            }

            player = new Howl({
                src: [streamUrl],
                format: ['mp3'],  // âœ… í™•ìž¥ìž ëª…ì‹œ (Howler.jsê°€ íŒŒì¼ íƒ€ìž…ì„ ì •í™•ížˆ ì¸ì‹í•˜ë„ë¡)
                html5: true, // âœ… ë°±ê·¸ë¼ìš´ë“œì—ì„œë„ ìžë™ ìž¬ìƒ ê°€ëŠ¥
                autoplay: true,
                volume: 1.0,
                onend: function () {
                    console.log(`Finished: ${track.title}`);
                    nextTrack();
                }
            });
        }

        function nextTrack() {
            currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
            console.log("Next track index:", currentTrackIndex);
            playTrack();
        }

        window.onload = async () => {
            await fetchTracks();
            playTrack();
        };
    </script>
</head>
<body>
    <h1>SoundCloud Shuffle Player (Flask + Howler.js)</h1>
    <button onclick="playTrack()">Start Playing</button>
</body>
</html>
