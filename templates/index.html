<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SoundCloud Shuffle Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
        background-color: #1a1a1a; /* Ïñ¥ÎëêÏö¥ ÌöåÏÉâ */
    }
    .glitch {
      font-family: 'Pixelify Sans', sans-serif;
      text-shadow: 
        0 0 5px #00f7ff,
        0 0 10px #00f7ff,
        0 0 20px #00f7ff,
        0 0 40px #00f7ff;
    }
    @keyframes glow {
        0% { text-shadow: 0 0 5px #00f7ff, 0 0 10px #00f7ff; }
        50% { text-shadow: 0 0 15px #00f7ff, 0 0 30px #00f7ff; }
        100% { text-shadow: 0 0 5px #00f7ff, 0 0 10px #00f7ff; }
    }

    .glow-on-click {
        animation: glow 0.6s ease-in-out;
    }
  </style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

</head>
<body class="min-h-screen flex flex-col items-center justify-center text-white">

  <h1 class="text-2xl glitch mb-8"> Shuffle Player</h1>
  <img src="{{ url_for('static', filename='1.gif') }}" alt="Center GIF" class="w-80 h-auto mb-12">




  <button 
  onclick="handlePlayClick()"
  class="text-cyan-400 hover:text-cyan-300 text-5xl transition mb-8 glitch"
  id="playButton"
>
  <i class="fa-solid fa-play"></i>
</button>

  <div id="nowPlaying" class="text-center text-xl glitch"></div>
  <div id="loading" class="hidden animate-pulse text-lg text-cyan-400 mb-6 glitch">LOADING...</div>
  <script>
    let tracks = [];
    let currentTrackIndex = 0;
    let player = null;
    let playlistLoaded = false;

    async function fetchTracks() {
      const playlistId = "{{ playlist_id }}"; 
      document.getElementById("loading").classList.remove("hidden");
      const response = await fetch(`/playlist/${playlistId}`);
      tracks = await response.json();
      playlistLoaded = true;
      document.getElementById("loading").classList.add("hidden");
      console.log("Fetched Tracks:", tracks);
    }

    function handlePlayClick() {
      if (!playlistLoaded) {
            initPlayer();  // ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏Í∞Ä ÏïÑÏßÅ Î°úÎìúÎêòÏßÄ ÏïäÏïòÎã§Î©¥ ÌÅ¥Î¶≠ Ïãú ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Î°úÎî©
        } else {
            playTrack();  // Ïù¥ÎØ∏ Î°úÎìúÎêú ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏Í∞Ä ÏûàÎã§Î©¥ Î∞îÎ°ú Ïû¨ÏÉù
        }

    
        const btn = document.getElementById('playButton');
        btn.classList.add('glow-on-click');

        // Ïï†ÎãàÎ©îÏù¥ÏÖò ÎÅùÎÇòÍ≥† glow ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
        setTimeout(() => {
        btn.classList.remove('glow-on-click');
        }, 600);
    }

    async function fetchTrackTitle(id) {
      try {
        const response = await fetch(`/track/${id}`);
        if (!response.ok) {
          throw new Error("Failed to fetch track title");
        }
        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error fetching track title:", error);
        return null;
      }
    }

    function playTrack() {
      if (!playlistLoaded || tracks.length === 0) {
        console.log("Tracks not ready.");
        return;
      }

      document.getElementById("loading").classList.remove("hidden");

      let track = tracks[currentTrackIndex];
      let streamUrl = `/stream/${track.id}`;
      fetchTrackTitle(track.id).then(fetchedTitle => {
        if (fetchedTitle) {
          title = fetchedTitle.title;
          artist = fetchedTitle.artist;
          document.getElementById("nowPlaying").innerText = `üéß ${artist} - ${title}`;
        }
      });

      if (player) {
        player.stop();
      }

      player = new Howl({
        src: [streamUrl],
        format: ['mp3'],
        html5: false,
        autoplay: true,
        volume: 1.0,
        onplay: function () {
          document.getElementById("loading").classList.add("hidden");
        },
        onend: function () {
          console.log(`Finished: ${track.title}`);
          nextTrack();
        },
        onloaderror: function (id, err) {
          console.error("Load Error:", err);
          document.getElementById("loading").classList.add("hidden");
        },
        onplayerror: function (id, err) {
          console.error("Play Error:", err);
          document.getElementById("loading").classList.add("hidden");
        }
      });
    }

    function nextTrack() {
      currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
      console.log("Next track index:", currentTrackIndex);
      playTrack();
    }

    async function initPlayer() {
      await fetchTracks();
      playTrack();
    }
  </script>
</body>
</html>
